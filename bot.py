from aiogram import Bot, types
from aiogram.dispatcher import Dispatcher
from aiogram.utils import executor

from config import TOKEN
from aiogram.types import ReplyKeyboardRemove, \
    ReplyKeyboardMarkup, KeyboardButton, \
    InlineKeyboardMarkup, InlineKeyboardButton

from aiogram.contrib.fsm_storage.memory import MemoryStorage

from aiogram.dispatcher.filters.state import StatesGroup, State
from aiogram.dispatcher import FSMContext

from main import parser, sender, new_first_name, new_photo, new_last_name


class GetChanal(StatesGroup):
    get_chanal = State()


class Sender(StatesGroup):
    get_users = State()
    get_text = State()


class NewFirstName(StatesGroup):
    get_name = State()


class NewLastName(StatesGroup):
    get_name = State()


class NewPhoto(StatesGroup):
    get_photo = State()


storage = MemoryStorage()

bot = Bot(token=TOKEN)
dp = Dispatcher(bot, storage=storage)

main_board = ReplyKeyboardMarkup(resize_keyboard=True)
parse_kb = KeyboardButton("üìÑ –ü–∞—Ä—Å–∏–Ω–≥")
sender_kb = KeyboardButton("‚úâ –†–∞—Å—Å—ã–ª–∫–∞")
new_first_name_kb = KeyboardButton("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∏–º—è")
new_last_name_kb = KeyboardButton("–£—Å—Ç–∞–Ω–æ–≤—Ç—å –Ω–æ–≤–æ–µ –≤—Ç–æ—Ä–æ–µ –∏–º—è")
new_photo_kb = KeyboardButton("–£—Å—Ç–∞–Ω–æ–≤—Ç—å –Ω–æ–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é")
main_board.add(parse_kb, sender_kb).row(new_first_name_kb, new_last_name_kb, new_photo_kb)


@dp.message_handler(commands=['start'])
async def process_start_command(message: types.Message):
    await message.reply("–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π —Ç–µ–ª–µ–≥—Ä–∞–º!",
                        reply_markup=main_board)


@dp.message_handler()
async def echo_message(msg: types.Message):
    if msg.text == "üìÑ –ü–∞—Ä—Å–∏–Ω–≥":
        await bot.send_message(msg.from_user.id, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —á–∞—Ç (–±–µ–∑ https://t.me/)")
        await GetChanal.get_chanal.set()
    elif msg.text == "‚úâ –†–∞—Å—Å—ã–ª–∫–∞":
        await bot.send_message(msg.from_user.id, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —Å –Ω–∏–∫–∞–º–∏ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏")
        await Sender.get_users.set()
    elif msg.text == "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∏–º—è":
        await bot.send_message(msg.from_user.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è")
        await NewFirstName.get_name.set()
    elif msg.text == "–£—Å—Ç–∞–Ω–æ–≤—Ç—å –Ω–æ–≤–æ–µ –≤—Ç–æ—Ä–æ–µ –∏–º—è":
        await bot.send_message(msg.from_user.id, "–í–≤–µ–¥–∏—Ç–µ –≤—Ç–æ—Ä–æ–µ –∏–º—è")
        await NewLastName.get_name.set()
    elif msg.text == "–£—Å—Ç–∞–Ω–æ–≤—Ç—å –Ω–æ–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é":
        await bot.send_message(msg.from_user.id, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ")
        await NewPhoto.get_photo.set()


@dp.message_handler(state=GetChanal.get_chanal)
async def get_chanal_handler(message: types.Message, state: FSMContext):
    await bot.send_message(message.from_user.id, "–ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞—á–∞–ª—Å—è, —ç—Ç–æ –∑–∞–π–º–µ—Ç –∫–∞–∫–æ–µ —Ç–æ –≤—Ä–µ–º—è")
    chanal = message.text
    try:
        await parser(chanal)
        await bot.send_document(message.from_user.id, open(f"{chanal}_members.txt", 'rb'))
    except Exception as e:
        await bot.send_message(message.from_user.id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ —á–∞—Ç–∞")
    await state.finish()


@dp.message_handler(state=Sender.get_users, content_types=['document'])
async def get_users_to_send(message: types.Message, state: FSMContext):
    file_info = await bot.get_file(message.document.file_id)
    downloaded_file = await bot.download_file(file_info.file_path)
    with open("users_to_spam.txt", 'wb') as new_file:
        new_file.write(downloaded_file.getvalue())
    await bot.send_message(message.from_user.id,
                           "–û—Ç–ª–∏—á–Ω–æ!\n–ù–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–ª—É—á–µ–Ω—ã\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–∞—Å—Å—ã–ª–∞—Ç—å—Å—è")
    await state.finish()
    await Sender.get_text.set()


@dp.message_handler(state=Sender.get_text)
async def get_users_to_send(message: types.Message, state: FSMContext):
    text = message.text
    await state.finish()
    await bot.send_message(message.from_user.id, "–†–∞—Å—Å—ã–ª–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å")
    await sender(text)
    await bot.send_message(message.from_user.id, "–†–∞—Å—Å–ª—ã–∫–∞ –æ–∫–æ–Ω—á–µ–Ω–∞")


@dp.message_handler(state=NewFirstName.get_name)
async def get_new_first_name(message: types.Message, state: FSMContext):
    name = message.text
    await state.finish()
    await new_first_name(name)
    await bot.send_message(message.from_user.id, "–ù–æ–≤–æ–µ –∏–º—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")


@dp.message_handler(state=NewLastName.get_name)
async def get_new_first_name(message: types.Message, state: FSMContext):
    name = message.text
    await state.finish()
    await new_last_name(name)
    await bot.send_message(message.from_user.id, "–ù–æ–≤–æ–µ –≤—Ç–æ—Ä–æ–µ –∏–º—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")


@dp.message_handler(state=NewPhoto.get_photo, content_types=['photo'])
async def get_new_photo(message: types.Message, state: FSMContext):
    await message.photo[-1].download('user_photo.jpg')
    await state.finish()
    await bot.send_message(message.from_user.id, "–ù–æ–≤–æ–µ —Ñ–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")


if __name__ == '__main__':
    executor.start_polling(dp)
